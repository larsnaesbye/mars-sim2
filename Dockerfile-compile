# Build stage
# the Maven project
FROM maven:3-amazoncorretto-20 AS build
WORKDIR /app/src

# Ideally the source code should be under a src subdirectory in GitHub repo
COPY pom.xml .
COPY mars-sim-core mars-sim-core/
COPY mars-sim-console mars-sim-console/
COPY mars-sim-headless mars-sim-headless/
COPY mars-sim-main mars-sim-main/
COPY mars-sim-mapdata mars-sim-mapdata/
COPY mars-sim-tools mars-sim-tools/
COPY mars-sim-ui mars-sim-ui/

RUN mvn -DskipTests=true package

# Package stage
FROM amazoncorretto:17
WORKDIR /app
# Override when building
COPY --from=build /app/src/mars-sim-headless/target/mars-sim-headless.jar mars-sim-headless.jar

# The folder /app/data/mars-sim build be a bind volume if the simulation state is persistent

# Cannot pass command line argument when using the JAR launcher
# Attempt to load if saved simulation is present or new if not. Use a different data directory that is mapped to a 
# Docker volume
ENTRYPOINT [ "java", "-cp", "/app/mars-sim-headless.jar", "org.mars_sim.headless.MarsProjectHeadless", "-load", "-new", "-timeratio", "1024", "-remote", "18080", "-datadir", "/app/data/mars-sim" ]
EXPOSE 18080